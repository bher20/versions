<%= form_for (setup_user(@user)) do |f| %>
  <% if @user.errors.any? %>
    <div id='error_explanation'>
      <h2><%= pluralize(@user.errors.count, 'error') %> prohibited this user from being saved:</h2>

      <ul>
      <% @user.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class='field'>
    <%= f.label :name %><br />
    <%= f.text_field :name %>
  </div>
  <div class='field'>
    <%= f.label :password %><br />
    <%= f.password_field :password %>
  </div>
  <%= f.fields_for :profile do |ff| %>
    <div class="field">
      <%= ff.label :first_name %><br />
      <%= ff.text_field :first_name %>
    </div>
    <div class="field">
      <%= ff.label :last_name %><br />
      <%= ff.text_field :last_name %>
    </div>
    <div class="field">
      <%= ff.label :email %><br />
      <%= ff.text_field :email %>
    </div>
    <div class="field">
      <%= f.label :roles %><br />
      <% for role in Role.all %>
          <%= check_box_tag 'profile[role_ids][]', role.id, @user.profile.role_ids.include?(role.id), :id => dom_id(role) %>
          <%= label_tag dom_id(role), role.name, :class => 'check_box_label' %>
      <% end %>
    </div>
  <% end %>
  <div class='actions'>
    <%= submit_or_cancel(f) %>
  </div>
<% end %>
